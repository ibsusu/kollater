var _=(e=>(e[e.NoHandle=0]="NoHandle",e[e.HasHandle=1]="HasHandle",e[e.Caching=2]="Caching",e[e.Cached=3]="Cached",e[e.BackedUp=4]="BackedUp",e[e.Downloading=5]="Downloading",e[e.Spreading=6]="Spreading",e[e.Uploading=7]="Uploading",e[e.Uploaded=8]="Uploaded",e))(_||{});/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const P=Symbol("Comlink.proxy"),S=Symbol("Comlink.endpoint"),V=Symbol("Comlink.releaseProxy"),x=Symbol("Comlink.finalizer"),A=Symbol("Comlink.thrown"),j=e=>typeof e=="object"&&e!==null||typeof e=="function",J={canHandle:e=>j(e)&&e[P],serialize(e){const{port1:t,port2:n}=new MessageChannel;return O(e,t),[n,[n]]},deserialize(e){return e.start(),W(e)}},X={canHandle:e=>j(e)&&A in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},C=new Map([["proxy",J],["throw",X]]);function Q(e,t){for(const n of e)if(t===n||n==="*"||n instanceof RegExp&&n.test(t))return!0;return!1}function O(e,t=globalThis,n=["*"]){t.addEventListener("message",function a(r){if(!r||!r.data)return;if(!Q(n,r.origin)){console.warn(`Invalid origin '${r.origin}' for comlink proxy`);return}const{id:o,type:s,path:i}=Object.assign({path:[]},r.data),c=(r.data.argumentList||[]).map(f);let l;try{const u=i.slice(0,-1).reduce((h,d)=>h[d],e),y=i.reduce((h,d)=>h[d],e);switch(s){case"GET":l=y;break;case"SET":u[i.slice(-1)[0]]=f(r.data.value),l=!0;break;case"APPLY":l=y.apply(u,c);break;case"CONSTRUCT":{const h=new y(...c);l=U(h)}break;case"ENDPOINT":{const{port1:h,port2:d}=new MessageChannel;O(e,d),l=K(h,[h])}break;case"RELEASE":l=void 0;break;default:return}}catch(u){l={value:u,[A]:0}}Promise.resolve(l).catch(u=>({value:u,[A]:0})).then(u=>{const[y,h]=L(u);t.postMessage(Object.assign(Object.assign({},y),{id:o}),h),s==="RELEASE"&&(t.removeEventListener("message",a),D(t),x in e&&typeof e[x]=="function"&&e[x]())}).catch(u=>{const[y,h]=L({value:new TypeError("Unserializable return value"),[A]:0});t.postMessage(Object.assign(Object.assign({},y),{id:o}),h)})}),t.start&&t.start()}function Z(e){return e.constructor.name==="MessagePort"}function D(e){Z(e)&&e.close()}function W(e,t){return M(e,[],t)}function k(e){if(e)throw new Error("Proxy has been released and is not useable")}function B(e){return w(e,{type:"RELEASE"}).then(()=>{D(e)})}const H=new WeakMap,v="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(H.get(e)||0)-1;H.set(e,t),t===0&&B(e)});function ee(e,t){const n=(H.get(t)||0)+1;H.set(t,n),v&&v.register(e,t,e)}function te(e){v&&v.unregister(e)}function M(e,t=[],n=function(){}){let a=!1;const r=new Proxy(n,{get(o,s){if(k(a),s===V)return()=>{te(r),B(e),a=!0};if(s==="then"){if(t.length===0)return{then:()=>r};const i=w(e,{type:"GET",path:t.map(c=>c.toString())}).then(f);return i.then.bind(i)}return M(e,[...t,s])},set(o,s,i){k(a);const[c,l]=L(i);return w(e,{type:"SET",path:[...t,s].map(u=>u.toString()),value:c},l).then(f)},apply(o,s,i){k(a);const c=t[t.length-1];if(c===S)return w(e,{type:"ENDPOINT"}).then(f);if(c==="bind")return M(e,t.slice(0,-1));const[l,u]=I(i);return w(e,{type:"APPLY",path:t.map(y=>y.toString()),argumentList:l},u).then(f)},construct(o,s){k(a);const[i,c]=I(s);return w(e,{type:"CONSTRUCT",path:t.map(l=>l.toString()),argumentList:i},c).then(f)}});return ee(r,e),r}function ne(e){return Array.prototype.concat.apply([],e)}function I(e){const t=e.map(L);return[t.map(n=>n[0]),ne(t.map(n=>n[1]))]}const G=new WeakMap;function K(e,t){return G.set(e,t),e}function U(e){return Object.assign(e,{[P]:!0})}function re(e,t=globalThis,n="*"){return{postMessage:(a,r)=>e.postMessage(a,n,r),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function L(e){for(const[t,n]of C)if(n.canHandle(e)){const[a,r]=n.serialize(e);return[{type:"HANDLER",name:t,value:a},r]}return[{type:"RAW",value:e},G.get(e)||[]]}function f(e){switch(e.type){case"HANDLER":return C.get(e.name).deserialize(e.value);case"RAW":return e.value}}function w(e,t,n){return new Promise(a=>{const r=ae();e.addEventListener("message",function o(s){!s.data||!s.data.id||s.data.id!==r||(e.removeEventListener("message",o),a(s.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:r},t),n)})}function ae(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var se=Object.freeze({__proto__:null,createEndpoint:S,expose:O,finalizer:x,proxy:U,proxyMarker:P,releaseProxy:V,transfer:K,transferHandlers:C,windowEndpoint:re,wrap:W});const F=C.get("proxy"),oe={canHandle(e){return e&&typeof e=="object"&&typeof e.next=="function"&&(typeof e[Symbol.iterator]=="function"||typeof e[Symbol.asyncIterator]=="function")},serialize(e){return F.serialize(U(e))},async*deserialize(e){const t=F.deserialize(e);for(;;){const{value:n,done:a}=await t.next();if(a)break;yield n}}};var b=ue,g=[],N="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var E=0,ie=N.length;E<ie;++E)g[E]=N[E];function ce(e){return g[e>>18&63]+g[e>>12&63]+g[e>>6&63]+g[e&63]}function le(e,t,n){for(var a,r=[],o=t;o<n;o+=3)a=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(e[o+2]&255),r.push(ce(a));return r.join("")}function ue(e){for(var t,n=e.length,a=n%3,r=[],o=16383,s=0,i=n-a;s<i;s+=o)r.push(le(e,s,s+o>i?i:s+o));return a===1?(t=e[n-1],r.push(g[t>>2]+g[t<<4&63]+"==")):a===2&&(t=(e[n-2]<<8)+e[n-1],r.push(g[t>>10]+g[t>>4&63]+g[t<<2&63]+"=")),r.join("")}let $=Promise.resolve().then(function(){return se}).then(e=>e),he=await $;const{transferHandlers:ye}=await $;ye.set("asyncGenerator",oe);class de{id;constructor(){this.id=-1}base58_map="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";to_base58(t,n){var a=[],r="",o,s,i,c;for(o in t)for(s=0,i=t[o],r+=i||r.length^o?"":1;s in a||i;)c=a[s],c=c?c*256+i:i,i=c/58|0,a[s]=c%58,s++;for(;s--;)r+=n[a[s]];return r}from_b58(t,n){var a=[],r=[],o,s,i,c;for(o in t){if(s=0,i=n.indexOf(t[o]),i<0)return;for(i||r.length^o||r.push(0);s in a||i;)c=a[s],c=c?c*58+i:i,i=c>>8,a[s]=c%256,s++}for(;s--;)r.push(a[s]);return new Uint8Array(r)}concatByteArray(t,n){let a=new Uint8Array(t.length+n.length);return a.set(t),a.set(n,t.length),a}concatByteArray3(t,n,a){let r=new Uint8Array(t.length+n.length+a.length);return r.set(t),r.set(n,t.length),r.set(a,t.length+n.length),r}test(){return"test"}async init(t){return this.id=t,!0}getProps(){return Object.getOwnPropertyNames(Object.getPrototypeOf(this)).concat(Object.getOwnPropertyNames(this))}incrementIV(t){for(let n=t.length-1;n>=0;n--)if(t[n]<255){t[n]++;break}else t[n]=0}async*streamFileInChunks(t,n){console.log({file:t});const a=t.stream().getReader();let r=0,o=new Uint8Array;for(;r<t.size;){const{value:s,done:i}=await a.read();if(i){o.byteLength>0&&(yield o);break}let c=new Uint8Array(o.byteLength+s.byteLength);for(c.set(o),c.set(s,o.byteLength);c.byteLength>=n;)yield c.subarray(0,n),c=c.subarray(n);console.log("setting carryOver",{chunk:c}),o=c,r+=s.byteLength}yield o}async*encryptFileForUpload([t,n,a,r,o]){let s=0;for await(const i of this.streamFileInChunks(t,n)){const c=new Uint8Array(await crypto.subtle.digest("SHA-256",i));if(b(c)!==a[s++])throw Error("hash of chunk does not validationHash");const u=await crypto.subtle.encrypt({name:"AES-GCM",iv:o,length:128},r,i);this.incrementIV(o),yield new Uint8Array(u)}}async processFile([t,n]){const a=[],r=[];console.log("processing",{file:t,directory:n});let s=crypto.getRandomValues(new Uint8Array(16)),i=crypto.getRandomValues(new Uint8Array(16)),c=await crypto.subtle.importKey("raw",s.buffer,{name:"AES-GCM"},!0,["encrypt","decrypt"]),l=await crypto.subtle.exportKey("raw",c);for await(const p of this.streamFileInChunks(t,5242880)){const m=await crypto.subtle.digest("SHA-1",p),q=await crypto.subtle.digest("SHA-256",p);a.push(new Uint8Array(m)),r.push(new Uint8Array(q))}let u=await this.calculateFullMerkleTree(r);const y=a.reduce((p,m)=>p+b(m),""),h=[];for(let p of u)for(let m of p)h.push(b(m));let d=h.at(-1)??"";d.length||console.warn("there was no hash generated for the processed file:",t.name??Error("no file name"));const T=b(new Uint8Array(l)),z=b(i);let Y=this.createTorrentMetaData(t.name,t.size,y,h,T,z);await this.writeFileAndTorrent(n,d,t,Y),console.log({rootHash:d,sha1Hashes:a,sha256Hashes:r,merkleTree:u,flatMerkleStrings:h});let R={state:_.Cached,fileType:t.type.length>0?t.type:t.name.slice(Math.min(t.name.lastIndexOf(".")+1,t.name.length-1)),name:t.name,hash:d,size:t.size,key:T,iv:z};return console.log({metadataLite:R}),R}async writeFileAndTorrent(t,n,a,r){const s=await(await t.getFileHandle(n,{create:!0})).createWritable();await s.write(a),await s.close();const c=await(await t.getFileHandle(n+"torrent",{create:!0})).createWritable();await c.write(JSON.stringify(r)),await c.close()}createTorrentMetaData(t,n,a,r,o,s){return{announce:"http://tracker.kollator.com/announce","announce-list":[["http://tracker.kollator.com/announce"],["udp://tracker.kollator.com:80/announce"],["https://kollater.com/announce"]],comment:"(^o^)/","created by":"Kollator","creation date":Date.now(),info:{name:t,"piece length":5*1024*1024,pieces:a,key:o,iv:s,"meta version":2,"file tree":{[t]:{"":{length:n,"pieces root":`urn:btmh:${r[r.length-1]}`}}},layers:{[`urn:btmh:${r[r.length-1]}`]:{hashes:r}}}}}async calculateFullMerkleTree(t){let n=[t];for(;t.length>1;){const a=[];for(let r=0;r<t.length;r+=2){const o=t[r],s=r+1<t.length?t[r+1]:o,i=new Uint8Array(o.length+s.length);i.set(o),i.set(s,o.length);const c=await crypto.subtle.digest("SHA-256",i);a.push(new Uint8Array(c))}n.push(a),t=a}return n}}let ge=new de;he.expose(ge);self.postMessage("ready");
